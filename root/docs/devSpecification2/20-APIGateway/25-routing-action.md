# ルーティングアクション

## BFF認証アクション

BFF認証アクション(requireAuthentication)は、本GatewayがBFFとして、OIDC認証処理の一部を肩代わりし、認証コードを保持します。このBFF認証アクションのアップルストリームと、指定するプロキシアクション(proxy)のアップストリームに、認証コードを転送します。

認証の特定のために、認証スコープのラベルをつけます。レルム内で、複数のホストをまたがるルールを設定できます。
「CHIPIN_SESSION_ID_｛認証スコープ｝」Cookie の値をキーとして、OIDC認証を行い、認証情報をセッションに保持します。

ただし、クッキーの範囲制限は、ホスト制限はレルムのサブドメインプロパティで設定し、パス制限はありません。

アクションの設定値
 - 認証スコープ (authScopeName)
 - アップストリームアドレス (protectedUpstream)
 - OIDC関連設定値(oidcClientId, oidcRedirectUrl, oidcAuthorizationEndpoint, oidcTokenEndpoint)

## プロキシアクション

プロキシアクション(proxy)は、リクエストをプロキシ先のサービスに転送するためのアクションです。プロキシ先サービスから返却されたものがレスポンスとなります。
このアクションは、リクエストを別のマイクロサービスに転送するために使用されます。アクションパイプラインで最後にマッチしたアップストリームが選択されます。

認証スコープを設定した場合は、そのスコープで認証済みの場合に、バックエンドに認証コードが送付されます。

アクションの設定値
- アップストリームのアドレス (upstream)
- 認証スコープ (任意) (authScopeName)

## ヘッダー設定アクション

ヘッダー設定アクション(setUpstreamRequestHeader,setDownstreamResponseHeader)は、アップストリームへのリクエストやダウンストリームへのレスポンスの、HTTP ヘッダーの設定を行うためのアクション。

ヘッダの設定は、Upsert動作(既存のヘッダは削除して更新、既存ヘッダがなければ追加)です。

アクションの設定値
 - ヘッダ名文字列 (name)
 - ヘッダ値文字列 (value)

## リダイレクトアクション

リダイレクトアクション(redirect)は、リダイレクトを行うためのアクションです。レスポンス stauts は 302 に設定され、リダイレクト先のURLは Location ヘッダに設定されます。その他のヘッダ変更などのアクションは無視されます。

アクションの設定値
 - 転送先のURL (url)

## 静的テキスト返却アクション

静的テキスト返却アクション(returnStaticText)は、短いテキストを返却し終了します。その他のヘッダ変更などのアクションは無視されます。(robot.txtを想定しています。)

アクションの設定値
 - 返却HTTPボディ文字列 (content)
 - 返却HTTPステータス番号 (status)

## サービス確認SSEアクション

⭐️要確認・未実装

このアクションは、SPN Hub 上で指定されたサービスが利用可能かどうかをチェックします。
利用可能である場合は、アクションは成功しますが、利用可能でない場合は 503 Service Unavailable エラーを返します。
そのレスポンスでは JavaScript により /.waitforAvailable の SSE を取得してサービスが利用可能になるのを待ちます。

## HSTS ヘッダーアクション (デフォルト)

> **注意事項**
> このアクションは必ず適用されるので、アクションルールに設定する必要はありません。

全ての通信のレスポンスヘッダーに HSTS ヘッダーを付与します。

ただし、
 - レスポンスフィルタの冒頭での追加とし、他のアクションによる上書きを許容。
 -  単純追加で既存の同じヘッダがあっても追加する。
 - 一部のレスポンスフィルタを経由しないルートでは、付与されないことがある。

```
Strict-Transport-Security: max-age=<seconds>; includeSubDomains; preload
```

## デバイスID管理アクション (デフォルト)

> **注意事項**
> このアクションは必ず適用されるので、アクションルールに設定する必要はありません。

このアクションは、クライアントに対し、有効期限の長いデバイス識別用のクッキー(CHIPIN_DEVICE_CONTEXT Cookie)を発行します。
クッキーは、JWT(JSON Web Token)で、ペイロードにはデバイス毎に一意となるデバイスIDが含まれ、レルムの鍵（インベントリのレルムの signingKeyプロパティ）で署名します。

 - デバイスIDは12文字の文字列で、擬似乱数9バイトをbase64でエンコードしたもので、ペイロードのsub値に格納されます。
 - クッキーが存在しない場合は新しいデバイスIDをを発行し、存在する場合はJWTの署名をチェックします。
 - JWTのペーロードは、issとexpをチェックします。有効期限が再発行閾値(保持期間の 50% の時間)を過ぎている場合は、クッキーを再発行します。exp 以外の値は引き継がれます。
 - デバイスIDは、軽量のため、サーバでは管理しいないので、サーバ側で無効化することはできません。セッションの有効期限が切れるまで有効です。

新しくデバイスIDを生成した場合、および再発行した場合はレスポンスヘッダに Cookie を以下のように追加します。
```
Set-Cookie: CHIPIN_DEVICE_CONTEXT=*JWT*;HttpOnly;Secure;SameSite=Strict;
```
クッキーの範囲制限は、ホスト制限はレルムのサブドメインプロパティで設定し、クッキーのパス制限の機能はありません。
サブドメインに shareCookie: true が設定されている場合は、CHIPIN_DEVICE_CONTEXT Cookie の Domain 属性にサブドメインの FQDN を設定します。
これにより、同じサブドメイン配下の仮想ホスト間でセッションを共有できます。

**ペイロード**
| クレーム名 | 型       | 説明                                |BFF内変数名 (⭐️未実装)|
|:-----------|:---------|:---------------------------------|---|
| iss        | string   | デバイスIDを発行した仮想ホストのFQDN | session_originator |
| sub        | string   | デバイスID.                      | session_id |
| cn         | string   | デバイスのCN（Common Name）     | session_cn |
| iat        | integer  | 発行日時（UNIXタイムスタンプ）     | session_start_at |
| exp        | integer  | 有効期限（UNIXタイムスタンプ）     | session_expire_at |

ただし、cn は利用者が設定した場合のみ設定されます。(⭐️未実装=固定値)