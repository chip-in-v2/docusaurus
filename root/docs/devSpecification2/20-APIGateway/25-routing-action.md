# ルーティングアクション

## BFF認証アクション

BFF認証アクション(requireAuthentication)は、本GatewayがBFFとして、OIDC認証処理の一部を肩代わりし、認証コードを保持します。このBFF認証アクションと、指定するプロキシアクション(proxy)のバックエンドに、認証コードを転送します。

認証は認証スコープで特定します。レルム内で、複数のホストをまたがるルールを設定できます。
「CHIPIN_SESSION_ID_｛認証スコープ｝」Cookie の値をキーとして、OIDC認証を行い、認証情報をセッションに保持します。

ただし、クッキーの範囲制限は、ホスト制限はレルムのサブドメインプロパティで設定し、パス制限はありません。

主なアクションの設定値は、
 - 認証スコープ (auth_scope_name)
 - アップストリームアドレス (protected_upstream)
 - OIDC関連設定値 (...)

...⭐️以下、既存ドキュメントを利用して、要整理 ...

## プロキシアクション

プロキシアクション(proxy)は、リクエストをプロキシ先のサービスに転送するためのアクションです。プロキシ先サービスから返却されたものがレスポンスとなります。
このアクションは、リクエストを別のマイクロサービスに転送するために使用されます。アクションパイプラインで最後にマッチしたアップストリームが選択されます。

設定に認証スコープを設定することができ、そのスコープで認証済みのセッションならば、バックエンドに認証コードが送付されます。

アクションの設定値
- アップストリームのアドレス (upstream)
- 認証スコープ (任意) (auth_scope_name)

## ヘッダー設定アクション

ヘッダー設定アクション(setUpstreamRequestHeader,setDownstreamResponseHeader)は、アップストリームへのリクエストやダウンストリームへのレスポンスの、HTTP ヘッダーの設定を行うためのアクション。

ヘッダの設定は、Upsert動作(既存のヘッダは削除して更新、既存ヘッダがなければ追加)です。

アクションの設定値は、
 - ヘッダ名文字列 (name)
 - ヘッダ値文字列 (value)

## リダイレクトアクション

リダイレクトアクション(redirect)は、リダイレクトを行うためのアクションです。レスポンス stauts は 302 に設定され、リダイレクト先のURLは Location ヘッダに設定されます。その他のヘッダ変更などのアクションは無視されます。

アクションの設定値は、
 - 転送先のURL (url)

## 静的テキスト返却アクション

静的テキスト返却アクション(returnStaticText)は、短いテキストを返却し終了します。その他のヘッダ変更などのアクションは無視されます。(robot.txtを想定しています。)

アクションの設定値は、
 - 返却HTTPステータス番号 (status)
 - 返却HTTPボディ文字列 (content)

## サービス確認SSEアクション

⭐️要確認・未実装

このアクションは、SPN Hub 上で指定されたサービスが利用可能かどうかをチェックします。
利用可能である場合は、アクションは成功しますが、利用可能でない場合は 503 Service Unavailable エラーを返します。
そのレスポンスでは JavaScript により /.waitforAvailable の SSE を取得してサービスが利用可能になるのを待ちます。

## HSTS ヘッダーアクション (デフォルト)

* このアクションは必ず適用されるので、アクションルールに設定する必要はありません。

全ての通信のレスポンスヘッダーに HSTS ヘッダーを付与します。

ただし、
 - レスポンスフィルタの冒頭での追加とし、他のアクションによる上書きを許容。
 -  単純追加で既存の同じヘッダがあっても追加する。
 - 一部のレスポンスフィルタを経由しないルートでは、付与されないことがある。

```
Strict-Transport-Security: max-age=<seconds>; includeSubDomains; preload
```

## デバイスID管理アクション (デフォルト)

:::note

== ⭐️10-overviewの類似で異なる記述を要マージ ==

デバイスIDには、CSPRNG（暗号論的擬似乱数生成器）アルゴリズムを使って9バイトの乱数を生成し、base64エンコードした12文字の文字列を使用します。
JWTにはレルムの鍵（インベントリのレルムの signingKeyプロパティ）で署名します。
...
保持期間の 50% の時間を経過してアクセスすると同じデバイスIDで Cookie が再発行されます。従って、セッション保持期間よりも認証トークンのライフタイムが長い場合はライフタイムが残っているにも関わらずログアウトしてしまう場合がありますので注意が必要です。
:::

* このアクションは必ず適用されるので、アクションルールに設定する必要はありません。
* ただし、クッキーの範囲制限は、ホスト制限はレルムのサブドメインプロパティで設定し、パス制限はありません。

このアクションは、CHIPIN_DEVICE_CONTEXT Cookie が存在しない場合、新しいデバイスIDをを発行します。
デバイスIDはPRNG（擬似乱数生成器）を使用して生成された48ビットの数値で、base64で 64文字の文字列にエンコードされます。

CHIPIN_DEVICE_CONTEXT Cookie が存在する場合は、JWTを検証し、 iss, exp の妥当性をチェックします。
sub の値をデバイスIDとして使用します。有効期限が再発行閾値を過ぎている場合は、CHIPIN_DEVICE_CONTEXT Cookie を再発行します。
exp 以外の値は引き継がれます。
デバイスIDはメモリ上に保存して管理しているわけではないので、サーバ側で無効化することはできません。セッションの有効期限が切れるまで有効です。

新しくデバイスIDを生成した場合、および再発行した場合はレスポンスヘッダに Cookie を以下のように追加します。
```
Set-Cookie: CHIPIN_DEVICE_CONTEXT=*JWT*;HttpOnly;Secure;SameSite=Strict;
```
サブドメインに shareCookie: true が設定されている場合は、CHIPIN_DEVICE_CONTEXT Cookie の Domain 属性にサブドメインの FQDN を設定します。
これにより、同じサブドメイン配下の仮想ホスト間でセッションを共有できます。

JWTのクレームは API Gateway のリクエストオブジェクトの変数として保存されます。
JWTのクレームおよびリクエストオブジェクト上の変数名は以下の通りです。

| クレーム名 | 型       | 説明                                |変数名|
|:-----------|:---------|:---------------------------------|---|
| iss        | string   | デバイスIDを発行した仮想ホストのFQDN | session_originator |
| sub        | string   | デバイスID.                      | session_id |
| cn         | string   | デバイスのCN（Common Name）     | session_cn |
| iat        | integer  | 発行日時（UNIXタイムスタンプ）     | session_start_at |
| exp        | integer  | 有効期限（UNIXタイムスタンプ）     | session_expire_at |
ただし、cn は利用者が設定した場合のみ設定されます。