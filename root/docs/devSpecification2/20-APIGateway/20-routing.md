# ルーティング処理

API Gateway は、リクエストを適切なサービスにルーティングするための機能を提供します。以下のセクションでは、ルーティングの基本的な概念と実装方法について説明します。

## SNIによる仮想ホストとレルムの特定

API Gateway は最初に SNIとHostヘッダで宛先のFQDNを判定します。FQDNをキーとして、仮想ホストを特定し、レルムが決定します。
仮装ホストが所属するレルムに設定されているルーティングチェーンを使用してリクエストを処理します。
ただし、SNIとHostヘッダが異なる場合や、仮想ホストが登録されていない場合は、接続を拒否します。

## リクエストライフサイクル

以下に HTTP リクエストのライフサイクルを示します。

1. HTTP　リクエストのライフサイクルは、API Gatewayがクライアント(downstream)からリクエストヘッダを読み取ったときに始まります。
2. API Gateway はバックエンド（upstream）に接続します。再利用できる接続が既に確立されている場合、このステップはスキップされます。
3. API Gateway はリクエストヘッダをバックエンドに送信します。
4. リクエストヘッダが送信されると、API Gateway は二重モードに入り、同時に次の処理を実行します。
    - リクエストのボディ(存在する場合) をバックエンドに転送します
    - バックエンドからのレスポンス (ヘッダとボディの両方) をクライアントに転送します
5. リクエスト/レスポンス全体が終了すると、リクエストのライフサイクルは終了し、すべてのリソースが解放されます。クライアントとの接続とバックエンドとの接続は、条件を満たせば再利用のために維持されます。

## リクエストオブジェクト

ルーティングにおいてはリクエストごとにオブジェクトが作成されます。オブジェクトにはデバイスID、HTTPリクエストの属性、レスポンスヘッダなどが格納されます。
これは以下の機能で利用されます。

- デバイスID管理アクションでデバイスIDと関連付け
- ルーティングチェーンの match 式で参照
- setHeader, addCookie アクションで参照 (*25H2では未実装)
- setHeader, addCookie アクションでオブジェクトの値を変更 (*25H2では未実装)
- ログ出力アクションの値式で参照
- 認証アクションでセッションと関連付け


## BFF における認証処理

BFFにおいては、 認証認可サーバ(Keycloak等) と Open ID Connect プロトコルで連携して認証を実装します。

SPAのようなモダン Web アプリケーションにおいて、ブラウザ上スクリプトで認証コードを書かずに、認証に基づくアプリケーションを書くことができます。また、認証関連の情報の一部が、BFFないで処理されることで、セキュリティが向上する場合があります。

## ルーティングチェーンとアクションパイプライン

API Gateway ではルーティングチェーンを記述することでリクエストのライフサイクルに任意のロジック(アクション)を挿入できます。

ルーティングチェーンはルールのリストであり、順にルールの match 条件を評価し、条件を満たしたルールのアクションを実行します。順序が重要で、途中で終了し以降が実行されないアクションがあることに注意してください。

match 条件は、リクエストのhostnameとpathの値に対し、startsWith・endsWith・equalsの条件が利用できます。条件は1つ、または2つのandが使えます。

アクションについて[次の章](routing-action)で説明します。

API Gateway の実装ベースである Pingoraの以下のフィルタを利用します。その他のものは利用しません。特にresponse_body_filterは軽量のために利用しません。
- request_filter (初期確認、アクションパイプラインの作成、アクションパイプラインの正順で実行)
- upstream_peer (バックエンドへの転送)
- upstream_request_filter (アクションパイプラインを正順で実行し、バックエンドへのリクエストヘッダを変更)
- response_filter (アクションパイプラインを逆順で実行し、クライアントへのレスポンスヘッダを変更)

重要なPingoraの制限として、upstreamを使わずにレスポンスを返すには、request_filterの時点でレスポンスを返し終了します。そのようなアクションの場合には、後段のアクションが処理されないことに注意してください。

## サービス確認SSE

⭐️要確認

API Gateway ではサービスが利用可能になるのを待つための SSE (Server-Sent Events) を提供します。(詳細は、openapiのwaitfor-servicesを参照)(*25H2では未実装)

SSEは、
- SPAのフロントコードが利用するAPIで、
- ○○の認証を通った場合に利用でき、
- SPN HubのサービスのURNをキーとして、以下を行うことができる。
  - サービス状態の取得
  - サービスの起動のリクエスト
