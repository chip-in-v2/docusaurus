# yaml-language-server: $schema=../../openapi/inventory/realm-definition.yaml
realm:
  name: "master"
  title: "Master Realm"
  description: "Master realm for development purposes"
  disabled: false
  cacert: "${MASTER_CA_CERT}"
  signingKey: "${MASTER_REALM_SIGNING_KEY}"
zones:
  - zone: "${DEFAULT_ZONE_DOMAIN}"
    realm: "master"
    urn: "urn:chip-in:zone:master:${DEFAULT_ZONE_DOMAIN}"
    title: "Default Zone"
    description: "Default zone for the master realm"
    dnsProvider: "default-dns-provider"
    acmeCertificateProvider: "https://acme-v02.api.letsencrypt.org/directory"
subdomains:
  - name: "master"
    title: "Master Subdomain"
    urn: "urn:chip-in:subdomain:master:master"
    description: "Subdomain for the master realm"
    zone: "urn:chip-in:zone:master:${DEFAULT_ZONE_DOMAIN}"
virtualHosts:
  - name: "console"
    title: "Homepage Virtual Host"
    realm: "urn:chip-in:realm:master"
    urn: "urn:chip-in:virtual-host:master:console"
    routingChain: consoleChain
    subdomain: "urn:chip-in:subdomain:master:master"
    description: "Virtual host for the console"
routingChains:
  - name: consoleChain
    title: "Console Routing Chain"
    description: "Routing chain for the console"
    realm: "urn:chip-in:realm:master"
    urn: "urn:chip-in:routing-chain:master:consoleChain"
    rules:
      - match: "true"
        action:
          type: checkoutServices
          services:
            - "urn:chip-in:service:master:console-server"
            - "urn:chip-in:service:master:idp"
            - "urn:chip-in:service:master:db"
      - match: "true"
        action:
          type: setDeviceId
      - match: "true"
        action:
          type: "authentication"
          oidcClientId: "chipin-web"
          oidcClientSecret: "${OIDC_CLIENT_SECRET}"
          oidcAuthorizationEndpoint: "https://auth.master.${DEFAULT_ZONE_DOMAIN}/auth/realms/chip-in/protocol/openid-connect/auth"
          oidcTokenEndpoint: "https://auth.master.${DEFAULT_ZONE_DOMAIN}/auth/realms/chip-in/protocol/openid-connect/token"
          oidcService: "auth.master.${DEFAULT_ZONE_DOMAIN}"
          acceptLoginRedirectPathRegex: "^/console/.*$"
          oidcRedirectPath: "/auth/callback"
      - match: "true"
        action:
          type: "proxy"
          target: "urn:chip-in:service:master:console-server"
hubs:
  - name: "masterHub"
    title: "Master Hub"
    description: "Hub for the master realm"
    realm: "urn:chip-in:realm:master"
    urn: "urn:chip-in:hub:master:masterHub"
    fqdn: "hub.master.${DEFAULT_ZONE_DOMAIN}"
    serverCert: "${MASTER_HUB_SERVER_CERT}"
    serverCertKey: "${MASTER_HUB_SERVER_CERT_KEY}"
services:
  - name: console
    urn: urn:chip-in:service:master:console
    hub: "urn:chip-in:hub:master:masterHub"
    title: "Ops Frontier Console"
    realm: urn:chip-in:realm:master
    provider: 
      - "urn:chip-in:end-point:hub.master.${DEFAULT_ZONE_DOMAIN}:console-server"
    consumers:
      - urn:chip-in:end-point:hub.master.${DEFAULT_ZONE_DOMAIN}:api-gateway
  - name: idp
    urn: urn:chip-in:service:master:idp
    hub: "urn:chip-in:hub:master:masterHub"
    title: "Identity Provider"
    realm: urn:chip-in:realm:master
    provider: 
      - "urn:chip-in:end-point:hub.master.${DEFAULT_ZONE_DOMAIN}:idp-server"
    consumers:
      - urn:chip-in:end-point:hub.master.${DEFAULT_ZONE_DOMAIN}:api-gateway
  - name: db
    urn: urn:chip-in:service:master:db
    hub: "urn:chip-in:hub:master:masterHub"
    title: "Ops Frontier Database"
    realm: urn:chip-in:realm:master
    provider: 
      - "urn:chip-in:end-point:hub.master.${DEFAULT_ZONE_DOMAIN}:db-server"
    consumers:
      - "urn:chip-in:end-point:hub.master.${DEFAULT_ZONE_DOMAIN}:idp-server"
